================================
PROJECT STRUCTURE
========================================

    ├── .clasp.json
    ├── .gitignore
    ├── CONTRIBUTING.md
    ├── Dockerfile
    ├── LICENSE
    ├── README.md
    ├── TESTING.md
    ├── appsscript.json
    ├── docker-compose.yml
    ├── package.json
└── src/
        ├── Code.gs
        ├── Index.html
└── tests/
        ├── Code.test.js


========================================
FILE CONTENTS
========================================

--------------- File: .clasp.json ---------------

{
  "scriptId": "1B5GspqQz42nnkM94rHS-MXrRqa2bmwyD2KalEuw8RvGAdIU7SGsPEEbq",
  "rootDir": "src",
  "scriptExtensions": [
    ".js",
    ".gs"
  ],
  "htmlExtensions": [
    ".html"
  ],
  "jsonExtensions": [
    ".json"
  ],
  "filePushOrder": [],
  "skipSubdirectories": false
}

--------------- File: .gitignore ---------------

# Node dependencies
/node_modules

# Local clasp configuration file (for overriding credentials locally)
.clasp.local.json

# Build artifacts
/build
/dist

# Log files
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# OS-generated files
.DS_Store
Thumbs.db


--------------- File: CONTRIBUTING.md ---------------

Contributing to Gmail Data Extractor GAS App
First off, thank you for considering contributing! Your help is greatly appreciated.

How Can I Contribute?
Reporting Bugs
Ensure the bug was not already reported by searching on GitHub under Issues.

If you're unable to find an open issue addressing the problem, open a new one. Be sure to include a title and clear description, as much relevant information as possible, and a code sample or an executable test case demonstrating the expected behavior that is not occurring.

Suggesting Enhancements
Open a new issue to discuss your enhancement suggestion. Please provide a clear description of the enhancement and its potential benefits.

Pull Requests
Fork the repository.

Create your feature branch (git checkout -b feature/AmazingFeature).

Commit your changes (git commit -m 'Add some AmazingFeature').

Push to the branch (git push origin feature/AmazingFeature).

Open a Pull Request.

Styleguides
Please try to follow the coding style of the existing codebase.

Thanks!

--------------- File: Dockerfile ---------------

# Use the official Node.js Long-Term Support (LTS) version as a base image
FROM node:lts-alpine

# Install curl using the Alpine package manager (apk)
# --no-cache is used to keep the image size small by not storing the package index
RUN apk add --no-cache curl

# Set the working directory inside the container
WORKDIR /app

# Install Google Apps Script CLI (clasp) globally
# --unsafe-perm is used to handle potential permission issues during global npm installs
RUN npm install -g @google/clasp --unsafe-perm

# Set the default command to execute when the container starts.
# This will start an interactive shell, allowing us to run clasp commands manually.
CMD ["/bin/sh"]

--------------- File: LICENSE ---------------

MIT License

Copyright (c) 2025 <Your Name or Organization>

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

--------------- File: README.md ---------------

<details>
<summary>日本語 (Japanese)</summary>

# Gmail Data Extractor GAS App

## 1. 概要 (Overview)

本プロジェクトは、Google Apps Script (GAS) を利用し、ユーザーのGmailから指定された検索クエリに基づいてメールデータを抽出する汎用的なWebアプリケーションです。

Web UIを通じて手動で抽出を実行できるほか、Dockerを活用することで、ローカル開発環境をクリーンに保ち、再現性を高めています。

![アプリのスクリーンショット](./.assets/screenshot.png)

> **Note:** 上記のスクリーンショットを表示するには、このリポジトリに`.assets/screenshot.png`という名前で画像を配置してください。

## 2. 主な機能 (Features)

- **Web UIによるメール抽出:** ブラウザからGmailの検索クエリと最大取得件数を指定して、メールデータを抽出・表示できます。
- **柔軟な検索:** Gmailがサポートする全ての検索演算子（`from:`, `subject:`, `is:unread`など）を利用可能です。
- **モダンな開発環境:** Dockerと`clasp` (The Apps Script CLI) を利用し、ローカルでの開発とデプロイを効率化します。
- **オープンソース:** MITライセンスのもとで公開されており、自由に改変・利用できます。

## 3. 開発環境のセットアップ (Development Setup)

本プロジェクトでは、開発環境の構築にDockerを使用します。ホストマシンにNode.jsや`clasp`を直接インストールする必要はありません。

### 前提条件 (Prerequisites)

- [Docker Desktop](https://www.docker.com/products/docker-desktop/) または Docker Engine がインストールされていること。
- Googleアカウントを持っていること。

### セットアップ手順 (Setup Steps)

1.  **リポジトリをクローン:**
    ```bash
    git clone [https://github.com/yutaro89/Gmail-Data-Extractor-GAS-App.git](https://github.com/yutaro89/Gmail-Data-Extractor-GAS-App.git)
    cd Gmail-Data-Extractor-GAS-App
    ```

2.  **Dockerイメージの再構築とコンテナの起動:**
    プロジェクトのルートディレクトリで以下のコマンドを実行します。`Dockerfile`が更新されたため、`--build`フラグを付けてイメージを再構築し、コンテナを起動します。
    ```bash
    docker compose up -d --build
    ```

3.  **`clasp`でGoogleにログイン (重要):**
    Dockerコンテナ内からのログインは少し特殊な手順が必要です。**ターミナルを2つ使って作業します。**

    **【ターミナル ①】 - `clasp login` を実行する**
    a. 以下のコマンドでコンテナのシェルに接続します。
    ```bash
    docker compose exec clasp-dev /bin/sh
    ```
    b. コンテナ内で `clasp login` を実行します。
    ```bash
    # /app # のようなプロンプトで実行
    clasp login
    ```
    c. `Authorize clasp by visiting this URL:` の後に表示される `https://accounts.google.com/...` から始まる長いURLをコピーします。
    d. ホストPCのブラウザでそのURLを開き、Googleアカウントでログインして、権限を許可（続行）します。
    e. 許可すると、ブラウザは `http://localhost:xxxx` のようなアドレスにリダイレクトしようとして「このサイトにアクセスできません」といったエラー画面になります。**それで正常です。**
    f. そのエラー画面に表示されているURL（`http://localhost:xxxx/?code=4/0A...` のような形式）をすべてコピーします。
    g. **このターミナル①は、このまま待機させておきます。**

    **【ターミナル ②】 - 認証コードをコンテナに渡す**
    a. PCで**新しいターミナル**を開きます。
    b. 以下のコマンドを実行します。`'コピーしたURL'` の部分を、先ほど手順(f)でコピーしたURLに置き換えてください。**URLは必ずシングルクォート(')で囲ってください。**
    ```bash
    docker compose exec clasp-dev curl 'コピーしたURL'
    ```
    c. このコマンドを実行すると、ターミナル①の方で `Logged in successfully.` と表示され、ログインが完了します。

4.  **GASプロジェクトの作成と紐付け (推奨手順):**
    `clasp create`コマンドが不安定な場合があるため、手動でプロジェクトを作成し、`clasp clone`で紐付ける方法を推奨します。

    a. **ブラウザでGASプロジェクトを作成:**
       - [script.google.com](https://script.google.com/home/my) にアクセスします。
       - 「新しいプロジェクト」をクリックします。
       - 左上の「無題のプロジェクト」をクリックし、`Gmail Data Extractor` のような分かりやすい名前に変更します。

    b. **スクリプトIDをコピー:**
       - 左側のメニューから「プロジェクトの設定」（歯車アイコン）をクリックします。
       - 「ID」の項目にある「スクリプトID」をコピーします。

    c. **`clasp clone` を実行:**
       - ログインが完了している**ターミナル①**に戻ります。
       - 以下のコマンドを実行します。`YOUR_SCRIPT_ID`の部分を、先ほどコピーしたスクリプトIDに置き換えてください。
    ```bash
    # /app # のようなプロンプトで実行
    clasp clone "YOUR_SCRIPT_ID" --rootDir ./src
    ```
    このコマンドにより、`.clasp.json`ファイルが正しく生成されます。

5.  **Apps Script APIの有効化 (初回のみ):**
    `clasp push`を初めて実行する前に、お使いのGoogleアカウントで **Apps Script API** を有効にする必要があります。
    
    a. **[こちら](https://script.google.com/home/usersettings)のリンクから設定ページにアクセスします。**
    
    b. 「Google Apps Script API」の項目を見つけ、スイッチを「オン」に切り替えます。
    
    c. 設定の変更がシステム全体に反映されるまで数分かかることがあります。

6.  **ソースコードをGASプロジェクトにプッシュ:**
    APIを有効にした後、ターミナル①で以下のコマンドを実行します。
    ```bash
    # /app # のようなプロンプトで実行
    clasp push
    ```appsscript.json`の`oauthScopes`について警告が表示された場合は、`y`を入力して続行してください。

7.  **完了！**
    これで開発の準備が整いました。コードを編集した後は、再度`clasp push`を実行して変更を反映させてください。

## 4. デプロイと実行 (Deployment & Usage)

1.  **GASプロジェクトを開く:**
    `clasp open`コマンドはバージョンによって動作しないことがあるため、より確実な方法としてブラウザで直接プロジェクトを開きます。

    a. **スクリプトIDを確認:** 以下のコマンドで、`.clasp.json`ファイルに保存されているスクリプトIDを確認します。
    ```bash
    # /app # のようなプロンプトで実行
    cat .clasp.json
    ```
    b. **URLを開く:** ホストPCのブラウザで、以下のURLにアクセスします。`YOUR_SCRIPT_ID`の部分を、上記で確認したIDに置き換えてください。
    `https://script.google.com/d/YOUR_SCRIPT_ID/edit`

2.  **Webアプリとしてデプロイ:**
    - Webエディタ右上の「デプロイ」ボタンをクリックし、「新しいデプロイ」を選択します。
    - 歯車アイコンをクリックし、「ウェブアプリ」を選択します。
    - **説明:** (任意) `Initial deployment`など
    - **次のユーザーとして実行:** `自分` (USER_DEPLOYING)
    - **アクセスできるユーザー:** `自分のみ` (MYSELF)
    - 「デプロイ」ボタンをクリックします。

3.  **Webアプリへのアクセスと権限の許可 (初回のみ):**
    デプロイが完了すると、ウェブアプリのURLが表示されます。このURLに初めてアクセスすると、「Google hasn't verified this app (このアプリは Google で確認されていません)」という警告画面が表示されますが、これは正常な動作です。

    a. **警告画面を回避:**
       - **「詳細」** (Advanced) をクリックします。
       - **「(アプリ名)に移動（安全ではないページ）」** (Go to [App Name] (unsafe)) をクリックします。

    b. **権限を許可:**
       - 次の画面で、このアプリが要求する権限の一覧が表示されます。
       - 内容を確認し、**「許可」** (Allow) をクリックします。

    これでアプリケーションが表示され、利用できるようになります。

## 5. テスト (Testing)

アプリケーションが正しく動作することを確認するための手動テストケースをまとめています。機能の追加や修正を行った際は、以下のドキュメントを参照してリグレッションテストを実施してください。

- **[TESTING.md](./TESTING.md)**

## 6. プロジェクト構成 (Project Structure)

```
/
├── .github/              # GitHub Actions workflows
├── .gitignore            # Files to be ignored by Git
├── .clasp.json           # clasp configuration (Important: Do not ignore)
├── appsscript.json       # GAS manifest file
├── src/                  # Source code
│   ├── Code.gs           # Server-side logic
│   └── Index.html        # Web UI (HTML, CSS, JS)
├── README.md             # This file
├── TESTING.md            # Manual testing guide
├── LICENSE               # Project license
├── CONTRIBUTING.md       # Contribution guidelines
├── CODE_OF_CONDUCT.md    # Code of conduct
├── Dockerfile            # Docker image definition
└── docker-compose.yml    # Docker Compose configuration
```

## 7. ライセンス (License)

このプロジェクトは [MIT License](LICENSE) のもとで公開されています。

</details>

<details open>
<summary>English</summary>

# Gmail Data Extractor GAS App

## 1. Overview

This project is a versatile web application built with Google Apps Script (GAS) that extracts email data from a user's Gmail account based on a specified search query.

It allows manual extraction through a web UI and utilizes Docker to maintain a clean and reproducible local development environment.

![App Screenshot](./.assets/screenshot.png)

> **Note:** To display the screenshot above, place an image named `screenshot.png` in the `.assets/` directory of this repository.

## 2. Features

- **Email Extraction via Web UI:** Specify a Gmail search query and the maximum number of results to extract and display email data directly from your browser.
- **Flexible Search:** Supports all search operators provided by Gmail (e.g., `from:`, `subject:`, `is:unread`).
- **Modern Development Environment:** Streamlines local development and deployment using Docker and `clasp` (The Apps Script CLI).
- **Open Source:** Published under the MIT License, allowing you to freely modify and use the code.

## 3. Development Setup

This project uses Docker to build the development environment. You do not need to install Node.js or `clasp` directly on your host machine.

### Prerequisites

- [Docker Desktop](https://www.docker.com/products/docker-desktop/) or Docker Engine must be installed.
- A Google Account.

### Setup Steps

1.  **Clone the repository:**
    ```bash
    git clone [https://github.com/yutaro89/Gmail-Data-Extractor-GAS-App.git](https://github.com/yutaro89/Gmail-Data-Extractor-GAS-App.git)
    cd Gmail-Data-Extractor-GAS-App
    ```

2.  **Build the Docker image and start the container:**
    In the project root directory, run the following command. The `--build` flag rebuilds the image, which is necessary if the `Dockerfile` has been updated.
    ```bash
    docker compose up -d --build
    ```

3.  **Log in to Google with `clasp` (Important):**
    Logging in from within a Docker container requires a special procedure using **two terminals**.

    **[Terminal ①] - Run `clasp login`**
    a. Connect to the container's shell:
    ```bash
    docker compose exec clasp-dev /bin/sh
    ```
    b. Run `clasp login` inside the container:
    ```bash
    # Run this at a prompt like /app #
    clasp login
    ```
    c. Copy the long URL that appears after `Authorize clasp by visiting this URL:`, which starts with `https://accounts.google.com/...`.
    d. Open this URL in your host machine's browser, log in to your Google account, and grant the necessary permissions.
    e. After granting permission, your browser will try to redirect to an address like `http://localhost:xxxx` and show an error like "This site can’t be reached." **This is normal.**
    f. Copy the entire URL from the address bar of that error page (it will look like `http://localhost:xxxx/?code=4/0A...`).
    g. **Leave Terminal ① open and waiting.**

    **[Terminal ②] - Pass the authorization code to the container**
    a. Open a **new terminal** on your computer.
    b. Run the following command. Replace `'COPIED_URL'` with the URL you copied in step (f). **Make sure to enclose the URL in single quotes (').**
    ```bash
    docker compose exec clasp-dev curl 'COPIED_URL'
    ```
    c. After running this command, you should see `Logged in successfully.` in Terminal ①.

4.  **Create and link the GAS project (Recommended):**
    Since `clasp create` can sometimes be unstable, the recommended method is to create the project manually in the browser and then link it using `clasp clone`.

    a. **Create a GAS project in your browser:**
       - Go to [script.google.com](https://script.google.com/home/my).
       - Click "New project".
       - Click on "Untitled project" in the top-left and rename it to something recognizable, like `Gmail Data Extractor`.

    b. **Copy the Script ID:**
       - In the left sidebar, click on "Project Settings" (the gear icon).
       - Under "IDs", copy the "Script ID".

    c. **Run `clasp clone`:**
       - Return to **Terminal ①**, where you are logged in.
       - Run the following command, replacing `YOUR_SCRIPT_ID` with the ID you just copied.
    ```bash
    # Run this at a prompt like /app #
    clasp clone "YOUR_SCRIPT_ID" --rootDir ./src
    ```
    This command will correctly generate the `.clasp.json` file.

5.  **Enable the Apps Script API (First time only):**
    Before you can `clasp push` for the first time, you must enable the Apps Script API for your Google Account.
    
    a. **Visit the settings page using [this link](https://script.google.com/home/usersettings).**
    
    b. Find the "Google Apps Script API" setting and turn the switch "On".
    
    c. It may take a few minutes for the setting to take effect.

6.  **Push the source code to the GAS project:**
    After enabling the API, run the following command in Terminal ①:
    ```bash
    # Run this at a prompt like /app #
    clasp push
    ```
    If you see a warning about `oauthScopes` in `appsscript.json`, type `y` to proceed.

7.  **Done!**
    Your development environment is now ready. After editing your code, run `clasp push` again to sync your changes.

## 4. Deployment & Usage

1.  **Open the GAS Project:**
    Since `clasp open` can be unreliable depending on the version, it's more robust to open the project directly in your browser.

    a. **Get the Script ID:** Check the script ID stored in your `.clasp.json` file.
    ```bash
    # Run this at a prompt like /app #
    cat .clasp.json
    ```
    b. **Open the URL:** In your host machine's browser, navigate to the following URL, replacing `YOUR_SCRIPT_ID` with the ID from the previous step.
    `https://script.google.com/d/YOUR_SCRIPT_ID/edit`

2.  **Deploy as a Web App:**
    - In the top-right of the web editor, click the "Deploy" button and select "New deployment".
    - Click the gear icon and select "Web app".
    - **Description:** (Optional) e.g., `Initial deployment`
    - **Execute as:** `Me` (USER_DEPLOYING)
    - **Who has access:** `Only myself` (MYSELF)
    - Click "Deploy".

3.  **Access the Web App and Grant Permissions (First time only):**
    Once deployed, a URL for the web app will be displayed. When you first visit this URL, you will see a warning screen saying "Google hasn't verified this app." This is normal.

    a. **Bypass the warning:**
       - Click **"Advanced"**.
       - Click **"Go to [App Name] (unsafe)"**.

    b. **Grant permissions:**
       - On the next screen, a list of permissions required by the app will be displayed.
       - Review them and click **"Allow"**.

    The application will now load and be ready to use.

## 5. Testing

Manual test cases to ensure the application works correctly are outlined in this document. Please refer to it to perform regression testing after making changes or adding features.

- **[TESTING.md](./TESTING.md)**

## 6. Project Structure

```
/
├── .github/              # GitHub Actions workflows
├── .gitignore            # Files to be ignored by Git
├── .clasp.json           # clasp configuration (Important: Do not ignore)
├── appsscript.json       # GAS manifest file
├── src/                  # Source code
│   ├── Code.gs           # Server-side logic
│   └── Index.html        # Web UI (HTML, CSS, JS)
├── README.md             # This file
├── TESTING.md            # Manual testing guide
├── LICENSE               # Project license
├── CONTRIBUTING.md       # Contribution guidelines
├── CODE_OF_CONDUCT.md    # Code of conduct
├── Dockerfile            # Docker image definition
└── docker-compose.yml    # Docker Compose configuration
```

## 7. License

This project is licensed under the [MIT License](LICENSE).

</details>

--------------- File: TESTING.md ---------------

Testing Guide
This document outlines the manual testing procedures to ensure the application is working correctly.

Prerequisites
The application has been successfully deployed as a web app.

You have access to the web app's URL.

You have a Gmail account with various types of emails to test against.

Test Cases
Follow these test cases to verify the functionality of the email extraction feature. For each test, check if the results match your expectations.

1. Basic Keyword Tests
These tests check if the basic search functionality is working.

Test Case

Input Query

Expected Outcome

1.1 Single Keyword

A common word from an email

Emails containing that word are returned.

1.2 Phrase Search

"A specific phrase"

Emails containing the exact phrase are returned.

1.3 No Results

a_very_unlikely_string_xyz

"該当するメールは見つかりませんでした。" is displayed.

2. Operator Tests
These tests verify that Gmail's search operators are functioning correctly.

Test Case

Input Query

Expected Outcome

2.1 From a specific sender

from:test@example.com

Only emails from test@example.com are returned.

2.2 In the subject

subject:Important

Only emails with "Important" in the subject are returned.

2.3 Has attachment

has:attachment

Only emails with attachments are returned.

2.4 Is unread

is:unread

Only unread emails are returned.

2.5 Is starred

is:starred

Only starred emails are returned.

3. Combination & Advanced Tests
These tests check complex queries.

Test Case

Input Query

Expected Outcome

3.1 AND search

from:info@example.com is:unread

Unread emails from info@example.com are returned.

3.2 Exclusion search

subject:Meeting -from:internal@company.com

Emails with "Meeting" in the subject, but not from internal@company.com, are returned.

3.3 Date search (after)

after:2025/07/20

Only emails received after July 20, 2025 are returned.

3.4 Date search (before)

before:2025/07/01

Only emails received before July 1, 2025 are returned.

3.5 OR search with parentheses

subject:(Urgent OR Important)

Emails with either "Urgent" or "Important" in the subject are returned.

4. Input Field Tests
These tests check the behavior of the input fields themselves.

Test Case

Action

Expected Outcome

4.1 Max Results (Low)

Set "最大件数" to 1 and search.

A maximum of 1 email is returned.

4.2 Max Results (High)

Set "最大件数" to 500 and search.

A maximum of 500 emails are returned.

4.3 Empty Query

Clear the "検索クエリ" field and click the button.

An error message "エラーが発生しました: Error: Search query must be a non-empty string." is displayed.

After making any code changes, it is recommended to run through these test cases to check for any regressions.

--------------- File: appsscript.json ---------------

{
  "timeZone": "Asia/Tokyo",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "webapp": {
    "access": "MYSELF",
    "executeAs": "USER_DEPLOYING"
  },
  "oauthScopes": [
    "https://www.googleapis.com/auth/gmail.readonly",
    "https://www.googleapis.com/auth/script.external_request",
    "https://www.googleapis.com/auth/script.container.ui"
  ]
}


--------------- File: docker-compose.yml ---------------

services:
  # Define the development service for clasp
  clasp-dev:
    # Build the Docker image from the Dockerfile in the current directory
    build: .
    # Name the container for easier identification
    container_name: clasp_dev_container
    # Mount the entire project directory from the host to /app in the container.
    # This allows live code changes on the host to be reflected inside the container.
    volumes:
      - .:/app
    # Keep standard input open, which is necessary for an interactive shell
    stdin_open: true
    # Allocate a pseudo-TTY, which allows for an interactive terminal session
    tty: true

--------------- File: package.json ---------------

// package.json
{
  "name": "gmail-data-extractor-gas-app",
  "version": "1.0.0",
  "description": "A web app to extract data from Gmail.",
  "scripts": {
    "test": "jest"
  },
  "devDependencies": {
    "jest": "^29.0.0" 
  }
}

--------------- File: src\Code.gs ---------------

/**
 * @OnlyCurrentDoc
 *
 * The above comment directs Apps Script to limit the scope of file
 * access for this script to only the current document containing it.
 * This is a good security practice.
 */

/**
 * Serves the web application's user interface.
 * This function is automatically called when a user accesses the web app's URL.
 *
 * @param {GoogleAppsScript.Events.DoGet} e The event parameter for a GET request.
 * @returns {GoogleAppsScript.HTML.HtmlOutput} The HTML output for the web page.
 */
function doGet(e) {
  const template = HtmlService.createTemplateFromFile('Index');
  return template.evaluate()
    .setTitle('Gmail Data Extractor')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/**
 * Searches Gmail for threads matching the given query and extracts information from the first message of each thread.
 * This function is designed to be called from the client-side JavaScript.
 *
 * @param {string} searchQuery The search query string for Gmail (e.g., "is:unread").
 * @param {number} [maxResults=100] The maximum number of threads to retrieve. Defaults to 100, max is 500.
 * @returns {Array<Object>} An array of objects, where each object represents an email message.
 * @throws {Error} If the searchQuery is invalid or if a Gmail API error occurs.
 */
function getEmails(searchQuery, maxResults = 100) {
  // --- Input Validation ---
  if (!searchQuery || typeof searchQuery !== 'string' || searchQuery.trim() === '') {
    throw new Error('Search query must be a non-empty string.');
  }

  let adjustedMaxResults = parseInt(maxResults, 10);
  if (isNaN(adjustedMaxResults) || adjustedMaxResults <= 0) {
    adjustedMaxResults = 100; // Default if invalid
  }
  if (adjustedMaxResults > 500) {
    adjustedMaxResults = 500; // Enforce maximum limit
  }

  Logger.log(`Executing search with query: "${searchQuery}", maxResults: ${adjustedMaxResults}`);

  try {
    // --- Gmail Search ---
    const threads = GmailApp.search(searchQuery, 0, adjustedMaxResults);
    const emails = [];

    // --- Data Extraction ---
    threads.forEach(thread => {
      // スレッド内の最初のメッセージのみを対象とします
      const message = thread.getMessages()[0]; // Get the first message of each thread
      if (message) {
        let plainBody = '';
        try {
          // Isolate potential errors from getPlainBody()
          plainBody = message.getPlainBody();
        } catch (bodyError) {
          plainBody = `Error retrieving message body: ${bodyError.message}`;
          Logger.log(`Could not get plain body for message ID ${message.getId()}: ${bodyError.toString()}`);
        }

        // Create a snippet from the beginning of the plain body to avoid errors.
        const snippet = plainBody.substring(0, 250);

        emails.push({
          id: message.getId(),
          threadId: thread.getId(),
          from: message.getFrom(),
          subject: message.getSubject(),
          date: message.getDate().toISOString(),
          isUnread: message.isUnread(),
          snippet: snippet,
          plainBody: plainBody,
        });
      }
    });

    Logger.log(`Found ${emails.length} emails.`);
    return emails;

  } catch (e) {
    Logger.log(`Error during Gmail search: ${e.toString()}`);
    // Re-throw the error to be caught by the client-side FailureHandler
    throw new Error(`Failed to execute Gmail search. Original error: ${e.message}`);
  }
}


--------------- File: src\Index.html ---------------

<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary-color: #4285F4;
      --primary-dark-color: #3367D6;
      --background-color: #f8f9fa;
      --font-color: #3c4043;
      --border-color: #dadce0;
      --success-bg: #e6f4ea;
      --success-color: #1e8e3e;
      --error-bg: #fce8e6;
      --error-color: #d93025;
      --card-bg: #ffffff;
      --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--background-color);
      color: var(--font-color);
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: var(--primary-color);
      font-size: 24px;
      margin-bottom: 10px;
    }
    p {
      color: #5f6368;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .form-container {
      background-color: var(--card-bg);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .controls .form-group {
      flex-grow: 1;
    }
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background-color 0.2s;
      white-space: nowrap;
    }
    button:hover {
      background-color: var(--primary-dark-color);
    }
    button:disabled {
      background-color: #9e9e9e;
      cursor: not-allowed;
    }
    #status {
      padding: 12px;
      border-radius: 4px;
      margin-top: 20px;
      font-weight: 500;
      display: none; /* Hidden by default */
    }
    .status-success {
      background-color: var(--success-bg);
      color: var(--success-color);
      border: 1px solid var(--success-color);
    }
    .status-error {
      background-color: var(--error-bg);
      color: var(--error-color);
      border: 1px solid var(--error-color);
    }
    .result-item {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }
    .result-item h3 {
      font-size: 16px;
      margin: 0 0 5px 0;
    }
    .result-item p {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #5f6368;
    }
    .result-item .meta {
      font-size: 12px;
      color: #80868b;
    }
    .result-item pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      background-color: #f1f3f4;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gmailメール抽出アプリ</h1>
    <p>
      Gmailの検索クエリを入力してメールを抽出します。<br>
      例: <code>is:unread -has:userlabels</code>, <code>from:("example.com") subject:会議 after:2024/01/01</code>
    </p>

    <div class="form-container">
      <div class="form-group">
        <label for="searchQuery">検索クエリ</label>
        <input type="text" id="searchQuery" value="is:unread -has:userlabels">
      </div>
      <div class="controls">
        <div class="form-group" style="margin-bottom: 0;">
          <label for="maxResults">最大件数</label>
          <input type="number" id="maxResults" value="50" min="1" max="500">
        </div>
        <button id="extractButton">メールを抽出</button>
      </div>
    </div>

    <div id="status"></div>
    <div id="results"></div>
  </div>

  <script>
    // --- DOM要素の取得 ---
    const extractButton = document.getElementById('extractButton');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const searchQueryInput = document.getElementById('searchQuery');
    const maxResultsInput = document.getElementById('maxResults');

    // --- イベントリスナーの登録 ---
    // ページが読み込まれたら、ボタンにクリックイベントを登録する
    document.addEventListener('DOMContentLoaded', () => {
      extractButton.addEventListener('click', extractAndDisplayEmails);
    });

    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'status-error' : 'status-success';
      statusDiv.style.display = 'block';
    }

    function extractAndDisplayEmails() {
      // Disable button and show loading status
      extractButton.disabled = true;
      extractButton.textContent = 'Extracting...';
      resultsDiv.innerHTML = '';
      showStatus('Extracting emails...', false);

      const searchQuery = searchQueryInput.value;
      const maxResults = maxResultsInput.value;

      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .getEmails(searchQuery, maxResults);
    }

    function onSuccess(emails) {
      // Re-enable button
      extractButton.disabled = false;
      extractButton.textContent = 'メールを抽出';

      if (emails && emails.length > 0) {
        showStatus(`Extraction complete. Found ${emails.length} emails.`, false);
        let html = '';
        emails.forEach(email => {
          html += `
            <div class="result-item">
              <h3>${escapeHtml(email.subject)}</h3>
              <p class="meta">
                <strong>From:</strong> ${escapeHtml(email.from)}<br>
                <strong>Date:</strong> ${new Date(email.date).toLocaleString()}
              </p>
              <p><strong>Snippet:</strong> ${escapeHtml(email.snippet)}</p>
              <div><strong>Plain Body:</strong></div>
              <pre>${escapeHtml(email.plainBody)}</pre>
            </div>
          `;
        });
        resultsDiv.innerHTML = html;
      } else {
        showStatus('No matching emails were found.', false);
      }
    }

    function onFailure(error) {
      // Re-enable button
      extractButton.disabled = false;
      extractButton.textContent = 'メールを抽出';
      
      const errorMessage = `An error occurred: ${error.message}`;
      showStatus(errorMessage, true);
      console.error(errorMessage);
    }

    function escapeHtml(unsafe) {
      if (typeof unsafe !== 'string') return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>

--------------- File: tests\Code.test.js ---------------

// getEmails関数をインポート
const { getEmails } = require('./src/Code.gs');

// GASのグローバルオブジェクトをモックする
global.GmailApp = {
  // searchメソッドの挙動を偽装
  search: jest.fn().mockReturnValue([]), // デフォルトでは空配列を返す
};

global.Logger = {
  log: jest.fn(), // Logger.logが呼ばれたことを確認できるようにする
};

// テストケースを記述
describe('getEmails', () => {

  // 各テストの前にモックをリセット
  beforeEach(() => {
    GmailApp.search.mockClear();
    Logger.log.mockClear();
  });

  it('検索クエリが空文字列の場合、エラーをスローする', () => {
    // 期待する挙動：関数を呼び出すとエラーが発生すること
    expect(() => getEmails('')).toThrow('Search query must be a non-empty string.');
  });

  it('有効なクエリで呼び出された場合、GmailApp.searchを正しい引数で呼び出す', () => {
    const query = 'is:unread';
    const max = 50;
    getEmails(query, max);
    // 期待する挙動：GmailApp.searchが正しい引数で1回呼ばれたこと
    expect(GmailApp.search).toHaveBeenCalledWith(query, 0, max);
  });
  
  // 他にも「不正なmaxResultsの場合」などのテストケースを追加できます
});

